services:
  arrebol-weddings:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arrebol-weddings
    restart: unless-stopped
    networks:
      - traefik-public
    labels:
      # Habilitar Traefik
      - "traefik.enable=true"
      
      # Configuración HTTP
      - "traefik.http.routers.arrebol.rule=Host(`arrebolweddings.com`) || Host(`www.arrebolweddings.com`)"
      - "traefik.http.routers.arrebol.entrypoints=http"
      
      # Redirigir HTTP a HTTPS
      - "traefik.http.routers.arrebol.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      
      # Configuración HTTPS
      - "traefik.http.routers.arrebol-secure.rule=Host(`arrebolweddings.com`) || Host(`www.arrebolweddings.com`)"
      - "traefik.http.routers.arrebol-secure.entrypoints=https"
      - "traefik.http.routers.arrebol-secure.tls=true"
      - "traefik.http.routers.arrebol-secure.tls.certresolver=le"
      
      # Puerto del servicio
      - "traefik.http.services.arrebol.loadbalancer.server.port=3000"
      
      # Middleware para www redirect (opcional)
      - "traefik.http.middlewares.www-redirect.redirectregex.regex=^https://www.arrebolweddings.com/(.*)"
      - "traefik.http.middlewares.www-redirect.redirectregex.replacement=https://arrebolweddings.com/$${1}"
      - "traefik.http.middlewares.www-redirect.redirectregex.permanent=true"
      - "traefik.http.routers.arrebol-secure.middlewares=www-redirect"
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      # SMTP Configuration
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - CONTACT_EMAIL=${CONTACT_EMAIL:-hola@arrebolweddings.com}
      # Baserow CRM
      - BASEROW_URL=${BASEROW_URL:-https://data.arrebolweddings.com}
      - BASEROW_TABLE_ID=${BASEROW_TABLE_ID:-34}
      - BASEROW_TOKEN=${BASEROW_TOKEN}
      # Analytics
      - NEXT_PUBLIC_GA_ID=${NEXT_PUBLIC_GA_ID}

networks:
  traefik-public:
    external: true
